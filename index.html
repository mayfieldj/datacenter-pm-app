<script>
/* ==================== DATA ==================== */
const currentUser = 'Josh Mayfield';
let categories = JSON.parse(localStorage.getItem('dcpm_categories')) || [
    "Planning & Scheduling","Financial & Reporting","Procurement & Contracts",
    "Design & Coordination","Compliance & Permits"
];
let tasks = JSON.parse(localStorage.getItem('dcpm_tasks')) || [];
let assignees = JSON.parse(localStorage.getItem('dcpm_assignees')) || ['Josh Mayfield','Clarke Hurd'];
let taskCounter = parseInt(localStorage.getItem('dcpm_taskCounter')) || 10000000;

/* ==================== PERSISTENCE ==================== */
function persist(){
    localStorage.setItem('dcpm_categories', JSON.stringify(categories));
    localStorage.setItem('dcpm_tasks', JSON.stringify(tasks));
    localStorage.setItem('dcpm_assignees', JSON.stringify(assignees));
    localStorage.setItem('dcpm_taskCounter', taskCounter);
}

/* ==================== UI HELPERS ==================== */
function populateCategorySelect(){
    const sel = document.getElementById('taskCategory');
    sel.innerHTML = '';
    categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = cat;
        sel.appendChild(opt);
    });
}
function clearAddTaskForm(){
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    document.getElementById('taskDue').value = '';
    document.getElementById('taskPriority').value = 'low';
    document.getElementById('taskOwner').value = currentUser;
    document.getElementById('subscribersInput').innerHTML = '';
}

/* ==================== TASK RENDERING ==================== */
function renderTask(task){
    const div = document.createElement('div');
    div.className = 'task-item';
    div.dataset.id = task.id;
    div.innerHTML = `
        <div class="font-semibold">${task.title}</div>
        <div class="text-sm text-gray-600">${task.category}</div>
        <div class="flex space-x-2 mt-2">
            <span class="chip">${task.priority}</span>
            ${task.subscribers.map(s=>`<span class="chip">${s}<span class="chip-remove">×</span></span>`).join('')}
        </div>
    `;
    return div;
}
function renderTaskList(){
    const container = document.getElementById('taskList');
    container.innerHTML = '';
    if(tasks.length===0){
        container.innerHTML = '<div class="empty-state">No tasks yet. Click “+ Add Task” to create one.</div>';
        return;
    }
    tasks.forEach(t=>container.appendChild(renderTask(t)));
}

/* ==================== MENU (CATEGORIES) ==================== */
function renderMenu(){
    const list = document.getElementById('menuList');
    list.innerHTML = '';
    categories.forEach(cat=>{
        const item = document.createElement('div');
        item.className = 'menu-item';
        item.textContent = cat;
        item.addEventListener('click',()=>filterByCategory(cat));
        list.appendChild(item);
    });
}
function filterByCategory(cat){
    document.getElementById('viewHeader').textContent = cat;
    const filtered = tasks.filter(t=>t.category===cat);
    const container = document.getElementById('taskList');
    container.innerHTML = '';
    if(filtered.length===0){
        container.innerHTML = '<div class="empty-state">No tasks in this category.</div>';
    }else{
        filtered.forEach(t=>container.appendChild(renderTask(t)));
    }
}

/* ==================== ADD TASK FORM ==================== */
document.getElementById('showAddForm').addEventListener('click',()=>{
    document.getElementById('addTaskForm').classList.remove('hidden');
    document.getElementById('showAddForm').classList.add('hidden');
    populateCategorySelect();
});

document.getElementById('cancelTask').addEventListener('click',()=>{
    document.getElementById('addTaskForm').classList.add('hidden');
    document.getElementById('showAddForm').classList.remove('hidden');
    clearAddTaskForm();
});

/* ----- Subscribers chip input ----- */
document.getElementById('subscribersInput').addEventListener('keydown',e=>{
    if(e.key==='Enter' && e.target.value.trim()){
        const chip = document.createElement('span');
        chip.className='chip';
        const name = e.target.value.trim();
        chip.innerHTML = `${name}<span class="chip-remove">×</span>`;
        chip.querySelector('.chip-remove').onclick = ()=>chip.remove();
        e.target.before(chip);
        e.target.value='';
        e.preventDefault();
    }
});

/* ----- Submit new task ----- */
document.getElementById('submitTask').addEventListener('click',()=>{
    const title = document.getElementById('taskTitle').value.trim();
    if(!title) return alert('Title is required');

    const subscribers = Array.from(document.querySelectorAll('#subscribersInput .chip'))
                            .map(c=>c.firstChild.textContent);

    const newTask = {
        id: ++taskCounter,
        title,
        description: document.getElementById('taskDesc').value,
        due: document.getElementById('taskDue').value,
        priority: document.getElementById('taskPriority').value,
        category: document.getElementById('taskCategory').value,
        owner: document.getElementById('taskOwner').value,
        subscribers,
        starred: false
    };
    tasks.push(newTask);
    persist();
    renderTaskList();
    document.getElementById('addTaskForm').classList.add('hidden');
    document.getElementById('showAddForm').classList.remove('hidden');
    clearAddTaskForm();
});

/* ==================== ADD CATEGORY ==================== */
document.getElementById('addCategoryBtn').addEventListener('click',()=>{
    const input = document.getElementById('newCategory');
    const name = input.value.trim();
    if(name && !categories.includes(name)){
        categories.push(name);
        persist();
        renderMenu();
        input.value='';
    }
});

/* ==================== TASK CONTEXT MENU ==================== */
let currentContextTask = null;
document.getElementById('taskList').addEventListener('contextmenu',e=>{
    const item = e.target.closest('.task-item');
    if(!item) return;
    e.preventDefault();
    currentContextTask = tasks.find(t=>t.id==item.dataset.id);
    const menu = document.getElementById('contextMenu');
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    menu.style.display = 'block';
});
document.addEventListener('click',()=>document.getElementById('contextMenu').style.display='none');

document.querySelectorAll('.context-menu-item').forEach(item=>{
    item.addEventListener('click',()=>{
        const action = item.dataset.action;
        if(!currentContextTask) return;
        if(action==='open') openDetails(currentContextTask);
        else if(action==='star'){
            currentContextTask.starred = !currentContextTask.starred;
            persist();
            renderTaskList();
        }
        else if(action==='duplicate'){
            const dup = {...currentContextTask, id:++taskCounter, title: currentContextTask.title+' (copy)'};
            tasks.push(dup);
            persist();
            renderTaskList();
        }
        else if(action==='delete'){
            if(confirm('Delete this task?')){
                tasks = tasks.filter(t=>t.id!==currentContextTask.id);
                persist();
                renderTaskList();
                closeDetails();
            }
        }
        document.getElementById('contextMenu').style.display='none';
    });
});

/* ==================== DETAILS PANE ==================== */
function openDetails(task){
    document.getElementById('detailsPane').style.display='block';
    document.getElementById('taskIdDisplay').textContent = `#${task.id} – ${task.title}`;
    const prio = document.getElementById('priorityBadge');
    prio.textContent = task.priority.toUpperCase();
    prio.className = `priority-high ${task.priority==='high'?'bg-red-500':task.priority==='mid'?'bg-yellow-400':'bg-green-500'}`;

    document.getElementById('detailsContent').innerHTML = `
        <div class="section-header">Description</div>
        <p>${task.description||'<em>None</em>'}</p>
        <div class="section-header">Due Date</div>
        <p>${task.due||'<em>None</em>'}</p>
        <div class="section-header">Owner</div>
        <p>${task.owner}</p>
        <div class="section-header">Subscribers</div>
        <div>${task.subscribers.map(s=>`<span class="chip">${s}</span>`).join('') || '<em>None</em>'}</div>
        <div class="section-header mt-4">
            <button class="btn btn-primary mr-2">Edit</button>
            <button class="btn bg-gray-300 text-gray-700">Save</button>
        </div>
    `;
}
function closeDetails(){
    document.getElementById('detailsPane').style.display='none';
}
document.getElementById('closeDetails').addEventListener('click',closeDetails);

/* ==================== INITIALISATION ==================== */
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('addTaskForm').classList.add('hidden');
    renderMenu();
    renderTaskList();
    populateCategorySelect();
    // default view
    if(categories.length) filterByCategory(categories[0]);
});
</script>
